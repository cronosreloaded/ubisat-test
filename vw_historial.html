<div class="container">
    <div class="block-header">
        <h2>Historial</h2>

        <ul class="actions">
            <li>
                <button data-toggle="dropdown" data-target="ddown-vehiculos" style="margin-top:-15px" href="" aria-expanded="false" class="btn btn-dropdown btn-default btn-icon waves-effect waves-circle waves-float"><i class="zmdi zmdi-car"></i></button>
                <div id="ddown-vehiculos" class="dropdown-menu dropdown-menu-lg" style="margin-left: -260px;">
                    <div class="list-group">
                        <div class="lg-header">
                            Veh√≠culos
                        </div>
                        <div class="lg-body">
                            <div id="listaVehiculos" class="list-group-item" style="max-height: 300px; overflow: auto">
                                <div class="checkbox m-b-15">
                                    <label><input type="checkbox" class="vehiculos" checked="" value="Todos"><i class="input-helper"></i>Todos</label>
                                </div> 
                            </div>  

                        </div>  

                    </div>
                </div>
            </li>  
            <li>
                <button data-toggle="dropdown" data-target="ddown-fechas" style="margin-top:-15px" href="" aria-expanded="false" class="btn btn-dropdown btn-default btn-icon waves-effect waves-circle waves-float"><i class="zmdi zmdi-calendar-check"></i></button>
            </li>
            <li>
                <button data-toggle="dropdown" data-target="ddown-buscar" style="margin-top:-15px" href="" aria-expanded="false" class="btn btn-dropdown btn-default btn-icon waves-effect waves-circle waves-float"><i class="zmdi zmdi-check"></i></button>
            </li>             
        </ul>

    </div>

    <div class="card">
        <div class="card-body p-10">
            <div id="map" style="width: 100%; height: 65%"></div>            
        </div>
    </div>    
</div>

<div id="tmp_vehiculo" style="display: none">
    <div class="checkbox m-b-15">
        <label><input type="checkbox" class="{{class}}" checked="" value="{{id}}"><i class="input-helper"></i>{{vehiculo}}</label>
    </div>
</div>
<script type="text/javascript">
var markerVehiculos = new Array();
function initMap(){
    var token = JSON.parse(localStorage.getItem("ubi-token"));
    center = token.centerMap;
    centroMapaLat = parseFloat(center.split(',')[0]);
    centroMapaLng = parseFloat(center.split(',')[1]);
    console.log("Instanciando mapa");
    map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: centroMapaLat, lng: centroMapaLng},
          zoom: 13
    });
    console.log("Mapa instanciado OK");
    var temporizador = setInterval(buscarPosiciones, 15000);
}

app.buscarVehiculos(agregarVehiculos);

$(".btn-dropdown").click(function(){
    var target = $(this).data("target");    
    $("#"+target).toggle();
})

function agregarVehiculos(){
    let tmp_Vehiculo = $("#tmp_vehiculo").html();
    for(i=0;i<app.vehiculos.length; i++){
        let html= tmp_Vehiculo.replace('{{id}}', app.vehiculos[i].ID).replace('{{vehiculo}}',app.vehiculos[i].Nombre);
        html = html.replace("{{class}}", "vehiculos");
        $("#listaVehiculos").append(html);
    }
    
    $(".vehiculos").unbind('click');
    $(".vehiculos").click(function(){        
        if ($(this).val() == "Todos"){
            var estado = $(this).is(":checked");
            $(".vehiculos").each(function(i,v){
                $(v).prop("checked", estado);
            })
        }
        buscarPosiciones();
    })
    buscarPosiciones();
}

function buscarPosiciones(){
    console.log("buscando");
    var lista = new Array();
	$(".vehiculos").each(function(i,v){
		if(i>0 && $(v).is(":checked")){			
			lista.push($(v).val());
		}
    })
	if (lista.length >0){
		//$("#preloader").show();
		$.ajax({
			type: "POST",
			url: "http://dev.ubisat.com.ar/api/usuario/getPosiciones",
			data: "lista="+lista,
			success:function(data){
                $("#mensaje").html(data);
				mostrarPos(JSON.parse(data));                
                //centrarMapa();
			}
		})
	}else{
		/*for(i=0;i<markerVehiculos.length;i++){		
			markerVehiculos[i].setMap(null);
		}*/
	}
}

function mostrarPos(data){		
	for(i=0;i<markerVehiculos.length;i++){		
		markerVehiculos[i].setMap(null);
	}
	var markerBounds = new google.maps.LatLngBounds();
	var mostrarNombre = $("#mostrarNombre").is(":checked");
	markerVehiculos = new Array();
	lista = data;
	for(i=0;i<data.length;i++){
		var image = {
		    url: 'img/iconovehiculos/'+getIcon(data[i].TipoVehiculo,data[i].speed, data[i].Icono),
		    origin: new google.maps.Point(0,0),	
            scaledSize:  new google.maps.Size(60, 60)       	    
		};
		var ubicacion = { lat: parseFloat(data[i].latitude), lng: parseFloat(data[i].longitude) };	
		
		if (mostrarNombre){
			var marker = new MarkerWithLabel({
			    position: ubicacion,
			    icon: image,
			    map:map,
			    labelAnchor: new google.maps.Point(40, 10),
			    labelClass: "labels", 
			    labelContent: data[i].name,		    
	    		labelStyle: {opacity: 0.8},
			});
		}else{
			var marker = new google.maps.Marker({
			    position: ubicacion,
			    icon: image,
			    map:map,			   
			});
		}	
		marker.id = i;	
		google.maps.event.addListener(marker, 'click', function () {                	
        	var content = getIWContent(lista[this.id]);
            infowindow.setContent(content);
            infowindow.open(map, this);
        });
		markerVehiculos.push(marker);
		//map.setCenter(ubicacion);
	}
	//map.fitBounds(markerBounds);
	
}

function getIcon(tipo, speed, icon){	
	var t= icon+"_";	
	if (speed == 0){
		t = t+"rojo.png";
	}else if(speed > 0 && speed <=10){
		t = t+"amarillo.png";
	}else{
		t = t+"verde.png";
	}
	return t;
}


</script>    
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB6-FGR1j1KT413lng13WOH-uT4oiGQtfs&callback=initMap"></script>
